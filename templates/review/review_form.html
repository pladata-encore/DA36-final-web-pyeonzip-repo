{% extends '../layout/base.html' %}
{% load static %}

{% block content %}
    <form action="" method="post" enctype="multipart/form-data">
        {% csrf_token %}
    <div class="container">    
        <!-- 1ï¸âƒ£ ì—°ê´€ ìƒí’ˆ ì„ íƒ -->
        <div class="p-5">
            <label for="selectedProduct" class="form-label"><strong>ğŸª™ í•´ë‹¹ ìƒí’ˆì— ëŒ€í•œ ë¦¬ë·°ë¥¼ ë‚¨ê¸°ê³  í¬ì¸íŠ¸ ë°›ì•„ê°€ì„¸ìš”~ ğŸª™</strong></label>
            <div id="selectedProductContainer" class="mb-3">
                {% if product_id %}
                    <script>
                        window.onload = function() {
                            fetch("{% url 'product:get_product' product_id %}")  // product_idì— í•´ë‹¹í•˜ëŠ” ìƒí’ˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                                .then(response => response.json())
                                .then(data => {
                                    setSelectedProduct(data.id, data.name, data.image_url, data.price, data.store, data.category);
                                });
                        };
                    </script>
                {% endif %}
            </div>
            <input type="hidden" id="selectedProductId" name="product_id" required>
            <button type="button" id="selectProductBtn" class="btn btn-primary" onclick="openProductPopup()">ìƒí’ˆ ì„ íƒ</button>
        </div>

        <!-- 2ï¸âƒ£ ë§› ë¦¬ë·° ì‘ì„± -->
        <div class="p-5">
            <label for="tasteContent" class="form-label"><strong>ğŸ½ï¸ ë§›ì€ ë§Œì¡±ìŠ¤ëŸ¬ìš°ì…¨ë‚˜ìš”?</strong></label>
            <textarea class="form-control" name="tasteContent" id="tasteContent" placeholder="ë§›ì— ëŒ€í•œ ì „ë°˜ì ì¸ í‰ê°€ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš” (20ì ì´ìƒ)" rows="2" minlength="20" maxlength="200" oninput="updateCharCount('tasteContent', 'charCountTaste'); checkFormCompletion();"></textarea>
            <div class="text-end"><span id="charCountTaste">0</span>/200</div>
        </div>

        <!-- 3ï¸âƒ£ ê°€ê²© ë¦¬ë·° ì‘ì„± -->
        <div class="p-5">
            <label for="priceContent" class="form-label"><strong>ğŸ’¸ ê°€ê²©ì€ ë§Œì¡±ìŠ¤ëŸ¬ìš°ì…¨ë‚˜ìš”?</strong></label>
            <textarea class="form-control" name="priceContent" id="priceContent" placeholder="ê°€ê²© ëŒ€ë¹„ ë§Œì¡±ë„ì— ëŒ€í•œ ì „ë°˜ì ì¸ í‰ê°€ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.(20ì ì´ìƒ)" rows="2" minlength="20" maxlength="200" oninput="updateCharCount('priceContent', 'charCountPrice'); checkFormCompletion();"></textarea>
            <div class="text-end"><span id="charCountPrice">0</span>/200</div>
        </div>

        <!-- 4ï¸âƒ£ í¸ì˜ì„± ë¦¬ë·° ì‘ì„± -->
        <div class="p-5">
            <label for="convenienceContent" class="form-label"><strong>ğŸ’¡ í•´ë‹¹ ì œí’ˆë§Œì˜ ëˆˆì— ë„ì—ˆë˜ íŠ¹ì§•ì€ ë¬´ì—‡ì¸ê°€ìš”?</strong></label>
            <textarea class="form-control" name="convenienceContent" id="convenienceContent" 
            placeholder="ì˜ˆì‹œ) 'ì•¼ì‹ìœ¼ë¡œ ìµœê³ ', 'ë¯¸ë‹ˆì‚¬ì´ì¦ˆë¼ íœ´ëŒ€ì„±ì´ ì¢‹ì•„ìš”' ë“±ê³¼ ê°™ì€ ì „ë°˜ì ì¸ íŠ¹ì§•ì— ëŒ€í•´ ì‘ì„±í•´ì£¼ì„¸ìš”. (20ì ì´ìƒ)" rows="10" minlength="20" maxlength="200" oninput="updateCharCount('convenienceContent', 'charCountConvenience'); checkFormCompletion();"></textarea>
            <div class="text-end"><span id="charCountConvenience">0</span>/200</div>
        </div>

        <div class="p-5">
            <label for="reviewImageUrl" class="form-label">ğŸ“· ë¦¬ë·° ì‚¬ì§„</label>
            <input class="form-control" type="file" id="reviewImageUrl" name="reviewImageUrl">
        </div>

        <!-- ë“±ë¡ ë²„íŠ¼ -->
        <div class="p-5 text-end">
            <button type="submit" id="submitBtn" class="btn btn-secondary" disabled>ë“±ë¡</button>
        </div>
    </div>
    </form>
    
{% endblock content %}

{% block script %}
<script>
        function openProductPopup() {
            if (document.getElementById("selectedProductId").value) {
                alert("ì´ë¯¸ ì„ íƒëœ ìƒí’ˆì´ ìˆìŠµë‹ˆë‹¤. ì‚­ì œ í›„ ë‹¤ì‹œ ì„ íƒí•˜ì„¸ìš”.");
                return;
            }
            window.open("{% url 'product:select_product' %}", "productPopup", "width=800,height=600");
        }
        
        function setSelectedProduct(productId, productName, productImageUrl, productPrice, productStore, productCategory) {
            if (document.getElementById("selectedProductId").value) {
                alert("ì´ë¯¸ ì„ íƒëœ ìƒí’ˆì´ ìˆìŠµë‹ˆë‹¤. ì‚­ì œ í›„ ë‹¤ì‹œ ì„ íƒí•˜ì„¸ìš”.");
                return;
            }
            document.getElementById("selectedProductId").value = productId;
            document.getElementById("selectedProductContainer").innerHTML = `
                <div class="d-flex align-items-center border p-3 rounded">
                    <img src="${productImageUrl}" class="rounded" alt="${productName}" style="width: 100px; height: 100px; object-fit: cover; margin-right: 15px;">
                    <div>
                        <p class="mb-1"><strong>${productName}</strong></p>
                        <p class="text-muted mb-1">ğŸ’° ${productPrice}ì› | ğŸª ${productStore} | ğŸ·ï¸ ${productCategory} </p>
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeProduct()">ì‚­ì œ</button>
                    </div>
                </div>
            `;
            document.getElementById("selectProductBtn").disabled = true;
            checkFormCompletion();
        }

        function removeProduct() {
            document.getElementById("selectedProductId").value = "";
            document.getElementById("selectedProductContainer").innerHTML = "";
            document.getElementById("selectProductBtn").disabled = false;
            checkFormCompletion();
        }
        
        function updateCharCount(textareaId, counterId) {
            const textarea = document.getElementById(textareaId);
            document.getElementById(counterId).innerText = textarea.value.length;
        }
        
        // í¼ ì…ë ¥ ì™„ë£Œ ì—¬ë¶€ í™•ì¸ (ëª¨ë“  ì¡°ê±´ ì¶©ì¡± ì‹œ ë²„íŠ¼ í™œì„±í™”)
        function checkFormCompletion() {
            const taste = document.getElementById("tasteContent").value.trim().length >= 20;
            const price = document.getElementById("priceContent").value.trim().length >= 20;
            const convenience = document.getElementById("convenienceContent").value.trim().length >= 20;
            const productSelected = document.getElementById("selectedProductId").value !== "";
            const submitBtn = document.getElementById("submitBtn");
            
            if (taste && price && convenience && productSelected) {
                submitBtn.disabled = false;
                submitBtn.classList.remove("btn-secondary");
                submitBtn.classList.add("btn-success");
            } else {
                submitBtn.disabled = true;
                submitBtn.classList.remove("btn-success");
                submitBtn.classList.add("btn-secondary");
            }
        }
        
    </script>
{% endblock script %}