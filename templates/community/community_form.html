{% extends '../layout/base.html' %}
{% load static %}


{% block content %}
    <form method="post">
        {% csrf_token %}
        
        <!-- 1ï¸âƒ£ ì—°ê´€ ìƒí’ˆ ì„ íƒ -->
        <div class="p-5">
            <label for="productId" class="form-label">ğŸ”ì—°ê´€ ìƒí’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”</label>
            <div class="d-flex">
                <input type="text" class="form-control" id="searchProduct" placeholder="Search..." readonly>
{#                <input class="form-control" id="productId" name="productId" placeholder="ì„ íƒëœ ìƒí’ˆ" readonly>#}
                <button type="button" class="btn btn-primary ms-2" onclick="openProductPopup()">+</button>
            </div>
            
            <!-- ì„ íƒí•œ ì œí’ˆ ëª©ë¡ -->
            <div id="selectedProducts" class="mt-3 d-flex flex-wrap"></div>

        </div>

         <!-- 2ï¸âƒ£ ì¹´í…Œê³ ë¦¬ ì„ íƒ -->
        <div class="p-5">
            <label class="form-label"><strong>ì¹´í…Œê³ ë¦¬</strong></label>
            <select class="form-select" aria-label="Default select example" id="categoryId" name="categoryId" onchange="checkFormCompletion()">
              <option selected>ì•„ì´ë””ì–´</option>
              <option value=1>ê¿€ì¡°í•©</option>
            </select>
        </div>

        <!-- 3ï¸âƒ£ ì œëª© ì…ë ¥ -->
        <div class="p-5">
          <label for="communityTitle" class="form-label"><strong>ì œëª©</strong></label>
          <input type="text"
                 class="form-control"
                 name="communityTitle"
                 id="communityTitle"
                 placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”. (50ì ì´ë‚´)" 
                 maxlength="50" 
                 oninput="checkFormCompletion()">
        </div>
        
        <!-- 4ï¸âƒ£ ë³¸ë¬¸ ì…ë ¥ -->
        <div class="p-5">
          <label for="communityContent" class="form-label"><strong>ë³¸ë¬¸</strong></label>
          <textarea
                  class="form-control"
                  name="communityContent"
                  id="communityContent"
                  rows="10" 
                  maxlength="200" 
                  oninput="updateCharCount(); checkFormCompletion()">
              
          </textarea>
            
            <!-- ê¸€ì ìˆ˜ ì¹´ìš´íŠ¸ í‘œì‹œ -->
            <div class="text-end"><span id="charCount">0</span>/200</div>
        </div>

        <!-- ë“±ë¡ ë²„íŠ¼ -->
        <div class="p-5 text-end">
            <button type="submit" id="submitBtn" class="btn btn-secondary" disabled>ë“±ë¡</button>
        </div>
    
    </form>
    
    
        <script>
        let selectedProducts = [];

        function openProductPopup() {
            window.open("{% url 'product:select_product' %}", "ì œí’ˆ ì„ íƒ", "width=600,height=500");
        }

        function setSelectedProduct(productId, productName, productImage) {
            if (!selectedProducts.some(p => p.id === productId)) {
                selectedProducts.push({id: productId, name: productName, image: productImage});
                updateSelectedProducts();
                checkFormCompletion();
            }
        }

        function updateSelectedProducts() {
            const container = document.getElementById("selectedProducts");
            container.innerHTML = "";

            selectedProducts.forEach((product, index) => {
                const card = document.createElement("div");
                card.className = "card m-2";
                card.style = "width: 150px;";

                card.innerHTML = `
                    <img src="${product.image}" class="card-img-top" alt="${product.name}" style="height: 100px;">
                    <div class="card-body text-center">
                        <p class="card-text">${product.name}</p>
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeProduct(${index})">ì‚­ì œ</button>
                    </div>
                `;

                container.appendChild(card);
            });
        }

        function removeProduct(index) {
            selectedProducts.splice(index, 1);
            updateSelectedProducts();
            checkFormCompletion();
        }

        function updateCharCount() {
            document.getElementById("charCount").innerText = document.getElementById("communityContent").value.length;
        }

        function checkFormCompletion() {
            const category = document.getElementById("categoryId").value;
            const title = document.getElementById("communityTitle").value.trim();
            const content = document.getElementById("communityContent").value.trim();
            const submitBtn = document.getElementById("submitBtn");
            
            console.log("Checking form completion..."); // ë””ë²„ê¹… ë¡œê·¸
            console.log("Selected Products:", selectedProducts.length);
            console.log("Category:", category);
            console.log("Title:", title);
            console.log("Content:", content);

            if (selectedProducts.length > 0 && category !== "" && title !== "" && content !== "") {
                submitBtn.disabled = false;
                submitBtn.classList.remove("btn-secondary");
                submitBtn.classList.add("btn-success");
            } else {
                submitBtn.disabled = true;
                submitBtn.classList.remove("btn-success");
                submitBtn.classList.add("btn-secondary");
            }
        }
    </script>
    
    
{% endblock content %}

