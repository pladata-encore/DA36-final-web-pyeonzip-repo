{% extends '../layout/base.html' %}

{% block css %}


{% endblock css %}

{% block content %}

    <div class="row">
        <div class="col-md-3">
                <img src="{{ product.product_image_url }}" class="img-fluid rounded-start" style="object-fit : cover;" alt="...">
         </div>

        <div class="col-md-9">
            <br>
            <br>
            <br>
            <br>
            <br>
            <div>ìƒí’ˆëª… : {{ product.product_name }}</div>
            <div>ìƒí’ˆ ì¹´í…Œê³ ë¦¬ : {{ product.product_category_name }}</div>

            <div>ìƒí’ˆ íŒë§¤ í¸ì˜ì  : {{ product.convenient_store_name }}</div>
            <div class="recommend" data-uri="{% url 'product:product_likes' product.product_id %}">
                <ion-icon id="heart-icon" name="{% if liked %}heart{% else %}heart-outline{% endif %}"></ion-icon>
                <span class="badge rounded-pill bg-success">{{ product.likes.count }}</span>
            </div>
            <div>
                <span class="card-text"><small class="text-body-secondary">ğŸ—¯ï¸ ë¦¬ë·°ê°œìˆ˜:{{ product.Product_reviews.count }}</small></span>
            </div>
        </div>

</div>


    {% for review in reviews %}
        <div class="card mb-3">
            <dl class="row">
                <dt class="col-sm-3">ì‘ì„±ì</dt>
                <dd class="col-sm-9">{{ review.author.nickname }}</dd>

                <dt class="col-sm-3">ë§›</dt>
                <dd class="col-sm-9">{{ review.tasteContent }}</dd>

                <dt class="col-sm-3">ê°€ê²©</dt>
                <dd class="col-sm-9">{{ review.priceContent }}</dd>

                <dt class="col-sm-3">í¸ë¦¬ì„±</dt>
                <dd class="col-sm-9">{{ review.convenienceContent }}</dd>

                <dt class="col-sm-3">í¸ë¦¬ì„±</dt>
                <dd class="col-sm-9"><img src="{{ review.reviewImageUrl.url}}" alt="Review Image"></dd>
            </dl>
        </div>
    {% endfor %}






{% endblock content %}

{% block script %}
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script>
        {# ì œí’ˆ ì¢‹ì•„ìš” ê¸°ëŠ¥ #}
        document.addEventListener("DOMContentLoaded", () => {
            const heartIcon = document.querySelector('#heart-icon');
            if (liked === 'true') {
                heartIcon.setAttribute('name', 'heart');
            } else {
                heartIcon.setAttribute('name', 'heart-outline');
            }
        });
        
        const recommend_elements = document.getElementsByClassName("recommend");
        Array.from(recommend_elements).forEach((element) => {
        // jsì˜ ë¹„ë™ê¸°ì²˜ë¦¬ë¥¼ ì§€ì›í•˜ëŠ” async..awaitì„ ì‚¬ìš©
        element.addEventListener('click', async (e) => {
            {% if not user.is_authenticated %}
                if (confirm('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    location.href = "{% url 'users:login' %}?next={{ request.path }}";
                }
                return false;
            {% endif %}


            {# dataset : data-* ì†ì„±ì— ì ‘ê·¼ ê°€ëŠ¥í•œ JavaScript DOM property #}
            // dataset.uriëŠ” data-uri ì†ì„±ê°’ ê°€ì ¸ì˜´
            // ->  '?.' (Optional Chaining) ì—°ì‚°ìë¡œ datasetì´ ì¡´ì¬í•  ê²½ìš°ì—ë§Œ urië¥¼ ì ‘ê·¼ ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ undefinedë¥¼ ë°˜í™˜

            // aíƒœê·¸ ë˜ëŠ” ìì‹spaníƒœê·¸ í´ë¦­ ëŒ€ì‘
            const url = e.target.dataset?.uri || e.target.parentElement.dataset.uri;

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                        },
                body: JSON.stringify({'product_id': {{ product.product_id }}}),
            });
            const data = await response.json();
            element.querySelector('span').textContent = data.likes_count;

            const heartIcon = element.querySelector('#heart-icon');
            if (data.liked) { // ì„œë²„ì—ì„œ ë°›ì€ ì¢‹ì•„ìš” ìƒíƒœ
                heartIcon.setAttribute('name', 'heart'); // ì±„ìš´ í•˜íŠ¸ë¡œ ë³€ê²½
            } else {
                heartIcon.setAttribute('name', 'heart-outline'); // ë¹ˆ í•˜íŠ¸ë¡œ ë³€ê²½
            }
            });
        });

    </script>
{% endblock script %}
