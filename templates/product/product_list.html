{% extends '../layout/base.html' %}

{% load static %}
{% block content %}

<div class="container">
    <div class="row">
        <div class="col-md-2">
            <div class="card mb-3" style="max-width: 100%; height: 130px;">
                <div class="card-body">
                    <div><label>
                        <input type="radio" name="store" value="ALL" onclick="filterProducts('ALL')" checked>
                        ALL
                    </label></div>
                    <div><label>
                        <input type="radio" name="store" value="CU" onclick="filterProducts('CU')">
                        CU
                    </label></div>
                    <div><label>
                        <input type="radio" name="store" value="GS25" onclick="filterProducts('GS25')">
                        GS25
                    </label></div>
                    <div> <label>
                        <input type="radio" name="store" value="7-ELEVEN" onclick="filterProducts('7-ELEVEN')">
                        7-ELEVEN
                    </label></div>
                </div>
            </div>
            <div class="card mb-3" style="max-width: 100%; height: 130px;">
                <div class="card-body">
                    <div><label>
                        <input type="radio" name="category" value="all" onclick="filterProductss('Í∞ÑÌé∏ÏãùÌíà')" checked>
                        Í∞ÑÌé∏ÏãùÌíà
                    </label></div>
                    <div><label>
                        <input type="radio" name="category" value="cu" onclick="filterProductss('Í≥ºÏûêÎ•ò')">
                        Í≥ºÏûêÎ•ò
                    </label></div>
                    <div><label>
                        <input type="radio" name="category" value="cu" onclick="filterProductss('ÏïÑÏù¥Ïä§ÌÅ¨Î¶º')">
                        ÏïÑÏù¥Ïä§ÌÅ¨Î¶º
                    </label></div>
                    <div> <label>
                        <input type="radio" name="category" value="cu" onclick="filterProductss('ÏùåÎ£å')">
                        ÏùåÎ£å
                    </label></div>
                </div>
            </div>
        </div>

        <div class="col-md-10">
            <div class="product-tab-btn">
                <button class="product-tab-btn btn btn-primary" onclick="openTab('all')">ALL</button>
                <button class="product-tab-btn btn" onclick="openTab('latest')">LATEST</button>
                <button class="product-tab-btn btn" onclick="openTab('ai')">AI</button>
            </div>

            <div id="product-tab-contents">
                {% for product in page_obj %}
                    <div class="card mb-3" style="max-width: 100%; height: 300px;">
                       <button type="button" class="btn">
                            <a href="{% url 'product:product_detail' product_id=product.product_id %}" class="text-decoration-none">
                              <div class="row g-0">
                                <div class="col-md-4">
                                    {% if product.product_image_url %}
                                        <img src="{{ product.product_image_url }}"  style="width:300px; height:300px;" alt="...">
                                    {% else %}
                                        <img src="{% static 'images/logo.png' %}" class="rounded-circle" width="26"/>
                                    {% endif%}
                                </div>
                                <div class="col-md-8">
                                  <div class="card-body">
                                    <h5 class="card-title">{{ product.product_name }}</h5>
                                    <p class="card-text">{{ product.product_price }}Ïõê</p>
                                    <p class="card-text"><small class="text-body-secondary">{{ product.convenient_store_name }}</small></p>
                                    <span class="card-text"><small class="text-body-secondary">‚ù§Ô∏è:{{ product.likes.count }}</small></span>
                                    <span class="card-text"><small class="text-body-secondary">üóØÔ∏è:{{ product.Product_reviews.count }}</small></span>
                                  </div>
                                </div>
                              </div>
                            </a>
                        </button>

                    </div>
                {% endfor %}
                     <!-- ÌéòÏù¥Ïßï Ï≤òÎ¶¨ ÏãúÏûë -->
                 <nav aria-label="Page navigation example">
                    <ul class="pagination justify-content-center">
                        <!-- Ïù¥Ï†ÑÌéòÏù¥ÏßÄ ÏòÅÏó≠ ÏãúÏûë -->
                       {% if page_obj.previous_page_number|add:-4 >= 0 %}
                                <li class="page-item">
                                    <a class="page-link" href="{% url 'product:product_list' tab='all' %}?page={{ page_obj.previous_page_number|add:-3 }}">Previous</a>
                                </li>
                        {% endif %}
                        <!-- Ïù¥Ï†ÑÌéòÏù¥ÏßÄ ÏòÅÏó≠ ÎÅù -->

                        <!-- ÌéòÏù¥ÏßÄÎÑòÎ≤Ñ ÏòÅÏó≠ ÏãúÏûë -->
                        {% for page_number in page_obj.paginator.page_range %}
                            {# ÌòÑÏû¨ÌéòÏù¥ÏßÄ Í∏∞Ï§Ä ÏïûÎí§ 3Í∞úÍπåÏßÄÎßå ÌëúÏãú (4 ~ 7 ÎßÅÌÅ¨ ÌëúÏãú) #}
                            {% if page_number >= page_obj.number|add:-3 and page_number <= page_obj.number|add:3 %}
                                {% if page_number == page_obj.number %}
                                    {# ÌòÑÏû¨ÌéòÏù¥ÏßÄÏù∏ Í≤ΩÏö∞ #}
                                    <li class="pagination-link active"><a class="page-link" href="#">{{ page_number }}</a></li>
                                {% else %}
                                    {# ÌòÑÏû¨ÌéòÏù¥ÏßÄÍ∞Ä ÏïÑÎãå Í≤ΩÏö∞ #}
                                    <li class="page-item">
                                        <a class="page-link" href="{% url 'product:product_list' tab='all' %}?page={{ page_number }}">{{ page_number }}</a>
                                    </li>
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                        <!-- ÌéòÏù¥ÏßÄÎÑòÎ≤Ñ ÏòÅÏó≠ ÎÅù -->

                    <!-- Îã§ÏùåÌéòÏù¥ÏßÄ ÏòÅÏó≠ ÏãúÏûë -->
                    {% if last_page >= page_obj.number|add:4 %}
                        <li class="page-item">
                                    <a class="page-link" href="{% url 'product:product_list' tab='all' %}?page={{ page_obj.next_page_number|add:+3 }}">Next</a>
                        </li>
                    {% endif %}
                <!-- Îã§ÏùåÌéòÏù¥ÏßÄ ÏòÅÏó≠ ÎÅù -->
                    </ul>
                </nav>
    <!-- ÌéòÏù¥Ïßï Ï≤òÎ¶¨ ÎÅù -->
        </div>


    </div>

</div>


</div>
{% endblock content %}
{% block script %}
<script>

    function openTab(tabName='all') {

        // Î™®Îì† Î≤ÑÌäºÏóêÏÑú active ÌÅ¥ÎûòÏä§Î•º Ï†úÍ±∞
        let tabButtons = document.getElementsByClassName("product-tab-btn");
        for (let i = 0; i < tabButtons.length; i++) {
            tabButtons[i].classList.remove("btn-primary");
            tabButtons[i].classList.add("btn");
        }

        // ÏÑ†ÌÉùÎêú ÌÉ≠ ÎÇ¥Ïö© ÌëúÏãú

        // ÏÑ†ÌÉùÎêú Î≤ÑÌäºÏóê active ÌÅ¥ÎûòÏä§ Ï∂îÍ∞Ä
        let selectedButton = document.querySelector(`button[onclick="openTab('${tabName}')"]`);
        selectedButton.classList.add("btn-primary");
        console.log(tabName)
        // AJAX ÏöîÏ≤≠ÏùÑ ÌÜµÌï¥ HTML ÏΩîÎìú Ï°∞Í∞Å Î∞õÏïÑÏò§Í∏∞
        fetch(`/product/product_list/${tabName}/`)
            .then(response => response.text())
            .then(html => {
                // ÏÑ†ÌÉùÎêú ÌÉ≠Ïóê HTML ÏΩîÎìú ÏÇΩÏûÖ
                document.getElementById("product-tab-contents").innerHTML = html;
            })
            .catch(error => {
                console.error('Error fetching HTML:', error);
                document.getElementById(tabName).innerHTML = '<p>Failed to load content.</p>';
            });

    }



        function filterProducts(store = 'ALL', category = null) {
        // ÏÑ†ÌÉùÎêú Ïä§ÌÜ†Ïñ¥ÏôÄ Ïπ¥ÌÖåÍ≥†Î¶¨ Í∞íÏùÑ Í∞ÄÏ†∏Ïò¥
        const selectedStore = store || document.querySelector("input[name='store']:checked").value;
        console.log(selectedStore)
        localStorage.setItem("selectedStoreFilter", store);
        const selectedCategory = category || document.querySelector("input[name='category']:checked").value;

        // fetch ÏöîÏ≤≠ÏúºÎ°ú ÌïÑÌÑ∞ÎßÅÎêú Ï†úÌíà Í∞ÄÏ†∏Ïò§Í∏∞
        fetch(`/product/filter_products/${store}/`)
            .then(response => response.text())  // JSONÏù¥ ÏïÑÎãàÎùº HTMLÏù¥ÎØÄÎ°ú `.text()` ÏÇ¨Ïö©
            .then(html => {
                document.getElementById("product-tab-contents").innerHTML = html;
            });
        }




    {#let currentPage = 1;#}
    {#let currentStore = "ALL"; // Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï#}
    {##}
    {#// ÏÉÅÌíà ÌïÑÌÑ∞ÎßÅ & ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò AJAX ÏöîÏ≤≠ Ìï®Ïàò#}
    {#function filterProducts(store , page = 1) {#}
    {#    let currentStore = store;#}
    {#    let currentPage = page;#}
    {##}
    {#    fetch(`{% url 'product:filter_products' %}?store=${store}&page=${page}`)#}
    {#        .then(response => response.json())#}
    {#        .then(data => {#}
    {#            let productList = document.getElementById("all_product_tab");#}
    {#            productList.innerHTML = ""; // Í∏∞Ï°¥ Î™©Î°ù ÎπÑÏö∞Í∏∞#}
    {##}
    {#            // Î∞õÏïÑÏò® ÏÉÅÌíà Îç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä#}
    {#            data.products.forEach(product => {#}
    {#                let productCard = `#}
    {#                    <div class="card mb-3" style="max-width: 100%; height: 300px;">#}
    {#                        <button type="button" class="btn">#}
    {#                            <a href="{% url 'product:product_detail' product_id=product.id %}" class="text-decoration-none">#}
    {##}
    {#                                <div class="row g-0">#}
    {#                                    <div class="col-md-4">#}
    {#                                        <img src="${product.image || '/static/images/logo.png'}" style="width:300px; height:300px;" alt="...">#}
    {#                                    </div>#}
    {#                                    <div class="col-md-8">#}
    {#                                        <div class="card-body">#}
    {#                                            <h5 class="card-title">${product.name}</h5>#}
    {#                                            <p class="card-text">${product.price}Ïõê</p>#}
    {#                                            <p class="card-text"><small class="text-body-secondary">${product.store}</small></p>#}
    {#                                            <span class="card-text"><small class="text-body-secondary">‚ù§Ô∏è:${product.likes}</small></span>#}
    {#                                            <span class="card-text"><small class="text-body-secondary">üóØÔ∏è:${product.reviews}</small></span>#}
    {#                                        </div>#}
    {#                                    </div>#}
    {#                                </div>#}
    {#                            </a>#}
    {#                        </button>#}
    {#                    </div>#}
    {#                `;#}
    {#                productList.innerHTML += productCard;#}
    {#            });#}
    {##}
    {#            // ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò ÏóÖÎç∞Ïù¥Ìä∏#}
    {#            updatePagination(data.total_pages);#}
    {#        })#}
    {#        .catch(error => console.error("Error:", error));#}


{#function updatePagination(currentPage, totalPages) {#}
{#    let paginationDiv = document.querySelector(".pagination");#}
{#    paginationDiv.innerHTML = ""; // Í∏∞Ï°¥ Î≤ÑÌäº Ï¥àÍ∏∞Ìôî#}
{##}
{#    // Ïù¥Ï†Ñ ÌéòÏù¥ÏßÄ Î≤ÑÌäº#}
{#    if (currentPage > 1) {#}
{#        let prevButton = document.createElement("li");#}
{#        prevButton.className = "page-item";#}
{#        prevButton.innerHTML = `<a class="page-link" href="#" onclick="filterProducts(currentStore, ${Math.max(1, currentPage - 3)}); return false;">Previous</a>`;#}
{#        paginationDiv.appendChild(prevButton);#}
{#    }#}
{##}
{#    // ÌéòÏù¥ÏßÄ Î≤àÌò∏ Î≤ÑÌäº#}
{#    let startPage = Math.max(1, currentPage - 3);#}
{#    let endPage = Math.min(totalPages, currentPage + 3);#}
{##}
{#    for (let i = startPage; i <= endPage; i++) {#}
{#        let pageItem = document.createElement("li");#}
{#        pageItem.className = (i === currentPage) ? "pagination-link active" : "page-item";#}
{#        pageItem.innerHTML = `<a class="page-link" href="#" onclick="filterProducts(currentStore, ${i}); return false;">${i}</a>`;#}
{#        paginationDiv.appendChild(pageItem);#}
{#    }#}
{##}
{#    // Îã§Ïùå ÌéòÏù¥ÏßÄ Î≤ÑÌäº#}
{#    if (currentPage < totalPages) {#}
{#        let nextButton = document.createElement("li");#}
{#        nextButton.className = "page-item";#}
{#        nextButton.innerHTML = `<a class="page-link" href="#" onclick="filterProducts(currentStore, ${Math.min(totalPages, currentPage + 3)}); return false;">Next</a>`;#}
{#        paginationDiv.appendChild(nextButton);#}
{#    }#}
{##}
{##}
{##}
{#// ÎùºÎîîÏò§ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ ÏÑ§Ï†ï#}
{#document.addEventListener("DOMContentLoaded", function () {#}
{#    let radioButtons = document.querySelectorAll("input[name='store']");#}
{#    #}
{#    radioButtons.forEach(radio => {#}
{#        radio.addEventListener("change", function () {#}
{#            currentStore = this.value; // ÏÑ†ÌÉùÌïú Ìé∏ÏùòÏ†ê Í∞í Ï†ÄÏû•#}
{#            filterProducts(currentStore, 1); // ÏÉàÎ°úÏö¥ ÏÑ†ÌÉùÍ∞íÏúºÎ°ú ÌïÑÌÑ∞ÎßÅ Ïã§Ìñâ#}
{#        });#}
{#    });#}
{##}
{#    // Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú#}
{#    filterProducts(currentStore, currentPage);#}


</script>

{% endblock script %}