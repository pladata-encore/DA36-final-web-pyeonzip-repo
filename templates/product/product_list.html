{% extends '../layout/base.html' %}

{% load static %}
{% block content %}

<div class="container">
    <div class="row">
        <div class="col-md-2">
            <div class="card mb-3" style="max-width: 100%; height: 130px;">
                <div class="card-body">
                    <div><label>
                        <input type="radio" name="store" value="ALL" onclick="filterProducts()" checked>
                        ALL
                    </label></div>
                    <div><label>
                        <input type="radio" name="store" value="CU" onclick="filterProducts()">
                        CU
                    </label></div>
                    <div><label>
                        <input type="radio" name="store" value="GS25" onclick="filterProducts()">
                        GS25
                    </label></div>
                    <div> <label>
                        <input type="radio" name="store" value="7-ELEVEN" onclick="filterProducts()">
                        7-ELEVEN
                    </label></div>
                </div>
            </div>
            <div class="card mb-3" style="max-width: 100%; height: 130px;">
                <div class="card-body">
                    <div><label>
                        <input type="radio" name="category" value="ALL" onclick="filterProducts()" checked>
                        Ï†ÑÏ≤¥ ÏÉÅÌíà
                    </label></div>
                    <div><label>
                        <input type="radio" name="category" value="Í∞ÑÌé∏Ïãù" onclick="filterProducts()" >
                        Í∞ÑÌé∏ÏãùÌíà
                    </label></div>
                    <div><label>
                        <input type="radio" name="category" value="Í≥ºÏûê" onclick="filterProducts()">
                        Í≥ºÏûêÎ•ò
                    </label></div>
                    <div><label>
                        <input type="radio" name="category" value="ÏïÑÏù¥Ïä§ÌÅ¨Î¶º" onclick="filterProducts()">
                        ÏïÑÏù¥Ïä§ÌÅ¨Î¶º
                    </label></div>
                    <div> <label>
                        <input type="radio" name="category" value="ÏùåÎ£å" onclick="filterProducts()">
                        ÏùåÎ£å
                    </label></div>
                </div>
            </div>
        </div>

        <div class="col-md-10">
            <div class="product-tab">
                <button class="product-tab-btn btn product-btn-primary" value="ALL" onclick="openTab('ALL')">ALL</button>
                <button class="product-tab-btn btn" value="LATEST" onclick="openTab('LATEST')">LATEST</button>
                <button class="product-tab-btn btn" value="AI" onclick="openTab('AI')">AI</button>
            </div>

            <div id="product-tab-contents">
                {% for product in page_obj %}
                    <div class="card mb-3" style="max-width: 100%; height: 300px;">
                       <button type="button" class="btn">
                            <a href="{% url 'product:product_detail' product_id=product.product_id %}" class="text-decoration-none">
                              <div class="row g-0">
                                <div class="col-md-4">
                                    {% if product.product_image_url %}
                                        <img src="{{ product.product_image_url }}"  style="width:300px; height:300px;" alt="...">
                                    {% else %}
                                        <img src="{% static 'images/logo.png' %}" class="rounded-circle" width="26"/>
                                    {% endif%}
                                </div>
                                <div class="col-md-8">
                                  <div class="card-body">
                                    <h5 class="card-title">{{ product.product_name }}</h5>
                                    <p class="card-text">{{ product.product_price }}Ïõê</p>
                                    <p class="card-text"><small class="text-body-secondary">{{ product.convenient_store_name }}</small></p>
                                    <span class="card-text"><small class="text-body-secondary">‚ù§Ô∏è:{{ product.likes.count }}</small></span>
                                    <span class="card-text"><small class="text-body-secondary">üóØÔ∏è:{{ product.Product_reviews.count }}</small></span>
                                  </div>
                                </div>
                              </div>
                            </a>
                        </button>
                    </div>
                {% endfor %}
                <nav aria-label="Page navigation example">
                    <ul class="pagination justify-content-center">
                        <!-- Ïù¥Ï†ÑÌéòÏù¥ÏßÄ ÏòÅÏó≠ ÏãúÏûë -->
                        {% if page_obj.previous_page_number|add:-4 >= 0 %}
                            <li class="page-item">
                                <button class="page-link" onclick="filterProducts({{ page_obj.previous_page_number|add:-3 }})">
                                    Previous
                                </button>
                            </li>
                        {% endif %}
                        <!-- Ïù¥Ï†ÑÌéòÏù¥ÏßÄ ÏòÅÏó≠ ÎÅù -->

                        <!-- ÌéòÏù¥ÏßÄÎÑòÎ≤Ñ ÏòÅÏó≠ ÏãúÏûë -->
                        {% for page_number in page_obj.paginator.page_range %}
                                            {% if page_number >= page_obj.number|add:-3 and page_number <= page_obj.number|add:3 %}
                                                {% if page_number == page_obj.number %}
                                                    <li class="pagination-link active"><a class="page-link" href="#">{{ page_number }}</a></li>
                                {% else %}
                                    {# ÌòÑÏû¨ ÌéòÏù¥ÏßÄÍ∞Ä ÏïÑÎãå Í≤ΩÏö∞ #}
                                    <li class="page-item">
                                        <button class="page-link" onclick="filterProducts({{ page_number }})">{{ page_number }}</button>
                                    </li>
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                        <!-- ÌéòÏù¥ÏßÄÎÑòÎ≤Ñ ÏòÅÏó≠ ÎÅù -->

                        <!-- Îã§ÏùåÌéòÏù¥ÏßÄ ÏòÅÏó≠ ÏãúÏûë -->
                        {% if last_page >= page_obj.number|add:4 %}
                           <button class="page-link" onclick="filterProducts({{ page_obj.next_page_number|add:+3 }})">
                                    Next
                            </button>
                          {% endif %}
                        <!-- Îã§ÏùåÌéòÏù¥ÏßÄ ÏòÅÏó≠ ÎÅù -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

{% endblock content %}
{% block script %}
<script>

    function openTab(tabName='all') {

        // Î™®Îì† Î≤ÑÌäºÏóêÏÑú active ÌÅ¥ÎûòÏä§Î•º Ï†úÍ±∞
        let tabButtons = document.getElementsByClassName("product-tab-btn");
        console.log(tabButtons)
        for (let i = 0; i < tabButtons.length; i++) {
            tabButtons[i].classList.remove("product-btn-primary");
            tabButtons[i].classList.add("btn");

            console.log(tabButtons[i].classList)
        }

        let selectedButton = document.querySelector(`button[onclick="openTab('${tabName}')"]`);

        selectedButton.classList.add("product-btn-primary");


        // AJAX ÏöîÏ≤≠ÏùÑ ÌÜµÌï¥ HTML ÏΩîÎìú Ï°∞Í∞Å Î∞õÏïÑÏò§Í∏∞
        fetch(`/product/filter_products/ALL/ALL/${tabName}/1`)
            .then(response => response.text())
            .then(html => {
                // ÏÑ†ÌÉùÎêú ÌÉ≠Ïóê HTML ÏΩîÎìú ÏÇΩÏûÖ
                document.getElementById("product-tab-contents").innerHTML = html;
            })
            .catch(error => {
                console.error('Error fetching HTML:', error);
                document.getElementById(tabName).innerHTML = '<p>Failed to load content.</p>';
            });

    }

    function filterProducts(page=1) {
    // ÏÑ†ÌÉùÎêú Ïä§ÌÜ†Ïñ¥ÏôÄ Ïπ¥ÌÖåÍ≥†Î¶¨ Í∞íÏùÑ Í∞ÄÏ†∏Ïò¥
    const selectedStore = document.querySelector("input[name='store']:checked").value;
    console.log(selectedStore)
    const selectedCategory = document.querySelector("input[name='category']:checked").value;
    tabname=document.getElementsByClassName("product-btn-primary")[0].value;
    // fetch ÏöîÏ≤≠ÏúºÎ°ú ÌïÑÌÑ∞ÎßÅÎêú Ï†úÌíà Í∞ÄÏ†∏Ïò§Í∏∞
    fetch(`/product/filter_products/${selectedStore}/${selectedCategory}/${tabname}/${page}`)
        .then(response => response.text())  // JSONÏù¥ ÏïÑÎãàÎùº HTMLÏù¥ÎØÄÎ°ú `.text()` ÏÇ¨Ïö©
        .then(html => {
            document.getElementById("product-tab-contents").innerHTML = html;

            });
    }

    if (document.addEventListener) {
      window.addEventListener('pageshow', function(event) {
        if (event.persisted || performance.getEntriesByType("navigation")[0].type === 'back_forward') {
          location.reload();
        }
      }, false);
    }

</script>

{% endblock script %}